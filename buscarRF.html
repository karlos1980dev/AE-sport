<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recuperar Código da Rifa</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; margin-top:100px;}
  h1 { margin: 10px 0; }
  input, button { padding: 8px; margin-top: 8px; }
  #resultado {
    background: white; padding: 15px; border-radius: 8px; 
    max-width: 400px; margin: 15px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    display: none;
  }
  .label { font-weight: bold; color:#000;}
</style>
</head>
<body>

<h1>Recuperar Código</h1>
<input type="text" id="codigoInput" placeholder="Digite o código da rifa">
<button id="buscar">Buscar</button>

<div id="resultado">
  <p><span class="label">Nome:</span> <span id="nome"></span></p>
  <p><span class="label">Números:</span> <span id="numeros"></span></p>
  <p><span class="label">Data/Hora:</span> <span id="dataHora"></span></p>
  <button id="verViewer">Ver na Viewer</button>
  <button id="compartilharWhatsApp" style="margin-left:10px;">Compartilhar no WhatsApp</button>
</div>

<script>
  // Configuração Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCIDFHMmzGkN3HGLn-XA8ieC_5DDBvbJ7o",
    authDomain: "rifa-782a3.firebaseapp.com",
    databaseURL: "https://rifa-782a3-default-rtdb.firebaseio.com",
    projectId: "rifa-782a3",
    storageBucket: "rifa-782a3.firebasestorage.app",
    messagingSenderId: "88068598855",
    appId: "1:88068598855:web:a230a06db76a4bbc125562"
  };

  // Inicializa Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const codigoInput = document.getElementById("codigoInput");
  const buscarBtn = document.getElementById("buscar");
  const resultadoDiv = document.getElementById("resultado");
  const nomeSpan = document.getElementById("nome");
  const numerosSpan = document.getElementById("numeros");
  const dataHoraSpan = document.getElementById("dataHora");
  const verViewerBtn = document.getElementById("verViewer");
  const compartilharBtn = document.getElementById("compartilharWhatsApp");

  let codigoEncontrado = "";

  buscarBtn.addEventListener("click", () => {
  const codigo = codigoInput.value.trim();
  if (!codigo) return alert("Digite o código!");

  // Limpar resultado e estado anterior
  nomeSpan.textContent = "";
  numerosSpan.textContent = "";
  dataHoraSpan.textContent = "";
  codigoEncontrado = "";
  resultadoDiv.style.display = "none";

  // Busca todos os dias dentro de compras-dia
  db.ref("compras-dia").once("value").then(snapshot => {
    if (!snapshot.exists()) {
      alert("Nenhuma reserva encontrada!");
      return;
    }
    
    let encontrado = null;
    snapshot.forEach(diaSnap => {
      // diaSnap é o nó do dia, exemplo: "2025-08-11"
      diaSnap.forEach(horarioSnap => {
        // horarioSnap é o nó do horário, ex: "10:00"
        horarioSnap.forEach(reservaSnap => {
          const dados = reservaSnap.val();
          if (dados.codigo === codigo) {
            encontrado = dados;
            return true; // para sair do forEach interno
          }
        });
        if (encontrado) return true; // sair do horário
      });
      if (encontrado) return true; // sair do dia
    });

    if (encontrado) {
      nomeSpan.textContent = encontrado.nome;
      numerosSpan.textContent = encontrado.numeros.join(", ");
      dataHoraSpan.textContent = encontrado.dataHora;
      codigoEncontrado = encontrado.codigo;
      resultadoDiv.style.display = "block";
    } else {
      alert("Código não encontrado!");
    }
  }).catch(err => {
    alert("Erro ao buscar: " + err);
  });

  });

  verViewerBtn.addEventListener("click", () => {
    if (codigoEncontrado) {
      window.location.href = `viewer.html?codigo=${encodeURIComponent(codigoEncontrado)}`;
    }
  });

  compartilharBtn.addEventListener("click", () => {
    if (!codigoEncontrado) {
      alert("Nenhum código encontrado para compartilhar!");
      return;
    }
    const urlViewer = `${window.location.origin}/viewer.html?codigo=${encodeURIComponent(codigoEncontrado)}`;
    const texto = `Veja a rifa que encontrei: ${urlViewer}`;
    const urlWhatsApp = `https://wa.me/?text=${encodeURIComponent(texto)}`;
    window.open(urlWhatsApp, '_blank');
  });
</script>

</body>
</html>
