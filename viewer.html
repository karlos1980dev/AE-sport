<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visualizador da Rifa</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #eee; padding: 20px; text-align: center; }
  .reserva-container {
    max-width: 500px;
    margin: 20px auto;
    background: #222;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 15px #0f0;
    text-align: left;
  }
  .campo-label {
    font-weight: bold;
    color: #7fff7f;
  }
  .status-aguardando { color: #f1c40f; font-weight: bold; }
  .status-ganhou { color: #27ae60; font-weight: bold; }
  .status-perdeu { color: #e74c3c; font-weight: bold; }
  .status-cancelou { color: #3498db; font-weight: bold; }
  .total-pagar {
    margin-top: 20px;
    font-size: 1.3rem;
    font-weight: bold;
    color: #0f0;
    border-top: 1px solid #0f0;
    padding-top: 10px;
  }
</style>
</head>
<body>

<h1>Visualizador da Rifa</h1>
<div id="reservas"></div>
<div id="totalPagar" class="total-pagar"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCIDFHMmzGkN3HGLn-XA8ieC_5DDBvbJ7o",
    authDomain: "rifa-782a3.firebaseapp.com",
    databaseURL: "https://rifa-782a3-default-rtdb.firebaseio.com",
    projectId: "rifa-782a3",
    storageBucket: "rifa-782a3.firebasestorage.app",
    messagingSenderId: "88068598855",
    appId: "1:88068598855:web:a230a06db76a4bbc125562"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const reservasDiv = document.getElementById("reservas");
  const totalPagarDiv = document.getElementById("totalPagar");

  function getParametro(nome) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(nome);
  }

  const codigoParam = getParametro("codigo");

  if (!codigoParam) {
    reservasDiv.innerHTML = "<p>Nenhum código informado na URL.</p>";
  } else {
    // Como as reservas estão agrupadas por horário, vamos buscar todas as reservas do dia que tem esse código
    // Para isso, assumo que a data da extração é hoje (pode adaptar se quiser)
    const dataHoje = new Date().toISOString().slice(0,10);

    db.ref(`compras-dia/${dataHoje}`).once("value").then(snapshot => {
      const dados = snapshot.val() || {};
      reservasDiv.innerHTML = "";
      let encontrou = false;
      let somaTotal = 0;

      for (const horario of Object.keys(dados).sort()) {
        const reservas = dados[horario];
        for (const codigoReserva in reservas) {
          const reserva = reservas[codigoReserva];
          if (reserva.codigo === codigoParam) {
            encontrou = true;

            // Cria container da reserva
            const div = document.createElement("div");
            div.className = "reserva-container";

            // Determina classe de status pra cor
            let statusClass = "";
            switch ((reserva.status || "").toLowerCase()) {
              case "ganhou": statusClass = "status-ganhou"; break;
              case "perdeu": statusClass = "status-perdeu"; break;
              case "cancelou": statusClass = "status-cancelou"; break;
              default: statusClass = "status-aguardando";
            }

            div.innerHTML = `
              <p><span class="campo-label">Código:</span> ${reserva.codigo}</p>
              <p><span class="campo-label">Nome:</span> ${reserva.nome}</p>
              <p><span class="campo-label">Números:</span> ${reserva.numeros.join(", ")}</p>
              <p><span class="campo-label">Horário Extração:</span> ${horario}</p>
              <p><span class="campo-label">Data e Hora:</span> ${reserva.dataHora}</p>
              <p>Status: <span class="${statusClass}">${reserva.status || "Aguardando resultado"}</span></p>
              <p><span class="campo-label">Valor a pagar:</span> R$ ${reserva.valorPagar ? reserva.valorPagar.toFixed(2) : "0,00"}</p>
            `;

            reservasDiv.appendChild(div);

            // Acumula valor para total
            somaTotal += (reserva.valorPagar ? Number(reserva.valorPagar) : 0);
          }
        }
      }

      if (!encontrou) {
        reservasDiv.innerHTML = "<p>Nenhum registro encontrado para este código.</p>";
        totalPagarDiv.textContent = "";
      } else {
        totalPagarDiv.textContent = `Total a pagar: R$ ${somaTotal.toFixed(2)}`;
      }
    }).catch(err => {
      reservasDiv.innerHTML = "<p>Erro ao carregar dados: " + err + "</p>";
    });
  }
</script>

</body>
  </html>
