<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #232; color:#fff}
    #numeros {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 2px;
      max-width: 520px;
      margin: 10px auto;
    }
    .numero {
      width: 39px;
      height: 35px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      background: #3498db;
      color: white;
      border: none;
    }
    .numero.marcado { background: #27ae60; }
    .numero.bloqueado {
      background: #888 !important;
      cursor: not-allowed;
      color: #ccc;
    }
    textarea { width: 90%; height: 180px; margin-top: 5px; white-space: pre-wrap; }
    input, select {
      padding: 5px;
      margin: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 16px;
    }
    button#salvar, button#copiarPix, button#enviarWhats {
      padding: 8px 15px;
      background: #2ecc71;
      color: white;
      border: none;
      cursor: pointer;
      margin: 5px;
      border-radius: 10px;
      font-size: 16px;
    }
    #pixContainer {
      margin-top: 10px;
      background: #111;
      padding: 10px;
      border-radius: 10px;
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
      word-break: break-word;
    }
    #qrcode {
      margin: 10px auto;
      width: 200px;
      height: 200px;
    }
  </style>
</head>
<body>

<h1>Rifa Online - 10 pra 600</h1>

<input type="text" id="nome" placeholder="Seu nome">

<select id="horarios" size="6">
  <option value="" disabled selected>HORÁRIO</option>
  <option value="10:00">10:00</option>
  <option value="12:00">12:00</option>
  <option value="15:00">15:00</option>
  <option value="19:00">19:00</option>
  <option value="21:00">21:00</option>
</select>

<br>

<input type="number" id="valor" placeholder="Valor unitário (R$)" min="0" step="0.01" style="width: 160px;">

<div id="numeros"></div>

<h3>RESERVADOS</h3>
<textarea id="codigo" readonly></textarea>

<div>
  <strong>Total a pagar: R$ <span id="totalPagar">0,00</span></strong>
</div>

<button id="salvar">Salvar Escolhas</button>

<div id="pixContainer" style="display:none;">
  <h3>Código PIX para pagamento:</h3>
  <div id="qrcode"></div>
  <textarea id="codigoPix" readonly style="width:90%; height:80px;"></textarea><br>
  <button id="copiarPix">Copiar Código PIX</button>
  <button id="enviarWhats">Enviar via WhatsApp</button>
</div>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyCIDFHMmzGkN3HGLn-XA8ieC_5DDBvbJ7o",
  authDomain: "rifa-782a3.firebaseapp.com",
  databaseURL: "https://rifa-782a3-default-rtdb.firebaseio.com",
  projectId: "rifa-782a3",
  storageBucket: "rifa-782a3.firebasestorage.app",
  messagingSenderId: "88068598855",
  appId: "1:88068598855:web:a230a06db76a4bbc125562"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const numerosDiv = document.getElementById('numeros');
const nomeInput = document.getElementById('nome');
const valorInput = document.getElementById('valor');
const codigoTextarea = document.getElementById('codigo');
const horariosSelect = document.getElementById('horarios');
const pixContainer = document.getElementById('pixContainer');
const codigoPixTextarea = document.getElementById('codigoPix');
const btnCopiarPix = document.getElementById('copiarPix');
const btnEnviarWhats = document.getElementById('enviarWhats');
const qrcodeDiv = document.getElementById('qrcode');
const totalPagarSpan = document.getElementById('totalPagar');

let selecionados = [];
let bloqueados = new Set();
let ultimoPix = null;
let ultimaReserva = null; // guardará dados para WhatsApp

// Criar botões 00 a 99
for (let i = 0; i < 100; i++) {
  let num = i.toString().padStart(2, '0');
  let btn = document.createElement('button');
  btn.textContent = num;
  btn.className = 'numero';
  btn.addEventListener('click', () => toggleNumero(btn, num));
  numerosDiv.appendChild(btn);
}

// Atualiza lista de números bloqueados do Firebase
function atualizarBloqueados() {
  db.ref('numerosBloqueados').once('value').then(snapshot => {
    bloqueados = new Set();
    const dados = snapshot.val() || {};
    for (let n in dados) {
      if(dados[n] === true) bloqueados.add(n);
    }
    atualizarBotoes();
  });
}

// Atualiza estados dos botões e total a pagar
function atualizarBotoes() {
  document.querySelectorAll('.numero').forEach(btn => {
    const n = btn.textContent;
    if (bloqueados.has(n)) {
      btn.classList.add('bloqueado');
      btn.classList.remove('marcado');
      btn.disabled = true;
      selecionados = selecionados.filter(x => x !== n);
    } else {
      btn.classList.remove('bloqueado');
      btn.disabled = false;
    }
  });
  atualizarTotalPagar();
}

// Atualiza o total a pagar exibido
function atualizarTotalPagar() {
  let valorUnit = parseFloat(valorInput.value.replace(',', '.'));
  if (isNaN(valorUnit) || valorUnit <= 0) valorUnit = 0;
  const total = valorUnit * selecionados.length;
  totalPagarSpan.textContent = total.toFixed(2).replace('.', ',');
}

function toggleNumero(botao, numero) {
  if (botao.classList.contains('bloqueado')) {
    alert(`Número ${numero} já está reservado!`);
    return;
  }
  if (botao.classList.contains('marcado')) {
    botao.classList.remove('marcado');
    selecionados = selecionados.filter(n => n !== numero);
  } else {
    botao.classList.add('marcado');
    selecionados.push(numero);
  }
  atualizarTotalPagar();
}

function gerarCodigoSimples() {
  const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  return `RIFA-${letras[Math.floor(Math.random() * letras.length)]}${letras[Math.floor(Math.random() * letras.length)]}${Math.floor(100 + Math.random() * 900)}`;
}

function getHoraAtual() {
  const now = new Date();
  let h = now.getHours();
  let m = now.getMinutes();
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
}

function atualizarHorarios() {
  const horarios = Array.from(horariosSelect.options);
  const horaAtual = getHoraAtual();

  for (let opt of horarios) {
    opt.disabled = false;
    opt.selected = false;
  }

  for (let opt of horarios) {
    if (opt.value <= horaAtual) {
      opt.disabled = true;
    }
  }

  let marcado = false;
  for (let opt of horarios) {
    if (!opt.disabled && !marcado) {
      opt.selected = true;
      marcado = true;
    }
  }
  if (!marcado) {
    for (let opt of horarios) {
      opt.selected = false;
    }
  }
}

atualizarHorarios();
setInterval(atualizarHorarios, 60000);

function atualizarTextareaReservas(dadosPorHorario) {
  let texto = "";
  for (let horario of Object.keys(dadosPorHorario).sort()) {
    texto += `Horário: ${horario}\n`;
    for (let key in dadosPorHorario[horario]) {
      const d = dadosPorHorario[horario][key];
      const numerosFormatados = d.numeros.join("-");
      texto += `${d.nome}: ${numerosFormatados}\n`;
    }
    texto += "=========================\n";
  }
  codigoTextarea.value = texto;
}

// Variável que guarda o dia atual para controlar quando limpar o textarea
let dataAtualReservas = new Date().toISOString().slice(0,10);

function carregarReservasDoDia(data) {
  db.ref(`compras-dia/${data}`).once('value').then(snapshot => {
    const dadosPorHorario = snapshot.val() || {};
    atualizarTextareaReservas(dadosPorHorario);
  });
}

function verificarDiaMudou() {
  const dataHoje = new Date().toISOString().slice(0,10);
  if (dataHoje !== dataAtualReservas) {
    // Dia mudou: limpa textarea e variáveis
    dataAtualReservas = dataHoje;
    codigoTextarea.value = "";
    selecionados = [];
    nomeInput.value = "";
    valorInput.value = "";
    totalPagarSpan.textContent = "0,00";
    horariosSelect.selectedIndex = -1;
    document.querySelectorAll('.numero.marcado').forEach(b => b.classList.remove('marcado'));
    atualizarBloqueados();
    carregarReservasDoDia(dataHoje);
    pixContainer.style.display = "none";
    qrcodeDiv.innerHTML = "";
    codigoPixTextarea.value = "";
  }
}

carregarReservasDoDia(dataAtualReservas);
setInterval(verificarDiaMudou, 60000);

valorInput.addEventListener('input', atualizarTotalPagar);

// Função para gerar um código PIX real simplificado (exemplo para testes)
function gerarPixCodeReal(valorTotal) {
  const chavePix = "12345678900"; // Troque para sua chave real
  const valorFormatado = valorTotal.toFixed(2).replace('.', '');
  return `00020126580014BR.GOV.BCB.PIX0136${chavePix}0208Pagamento520400005303986540${valorTotal.toFixed(2).replace('.', '')}5802BR5925Rifa Online - Reserva6009Sao Paulo61080540900062070503***6304ABCD`;
}

document.getElementById('salvar').addEventListener('click', () => {
  const nome = nomeInput.value.trim();
  if (!nome) return alert("Digite seu nome!");
  if (selecionados.length === 0) return alert("Selecione pelo menos um número!");
  const horariosSelecionados = Array.from(horariosSelect.selectedOptions).map(o => o.value);
  if (horariosSelecionados.length === 0) return alert("Selecione pelo menos um horário!");
  let valorUnit = parseFloat(valorInput.value.replace(',', '.'));
  if (isNaN(valorUnit) || valorUnit <= 0) return alert("Digite um valor válido maior que zero!");

  if(!confirm(`Confirma a reserva dos números ${selecionados.join(", ")} para o(s) horário(s): ${horariosSelecionados.join(", ")} com valor unitário R$ ${valorUnit.toFixed(2)}?`)) {
    return;
  }

  db.ref('numerosBloqueados').once('value').then(snapshot => {
    const bloqueios = snapshot.val() || {};
    const conflito = selecionados.find(n => bloqueios[n] === true);
    if (conflito) {
      alert(`O número ${conflito} já foi reservado por outro usuário. Atualizando lista.`);
      atualizarBloqueados();
      return;
    }

    const codigoSimples = gerarCodigoSimples();
    const codigoChave = "ID-" + Date.now();
    const dataHoraCompleta = new Date();
    const dataHoje = dataHoraCompleta.toISOString().slice(0,10);
    const dataHora = dataHoraCompleta.toLocaleString();

    const dadosBase = {
      nome,
      numeros: [...selecionados],
      dataHora,
      codigo: codigoSimples,
      valorUnitario: valorUnit
    };

    let promessas = [];
    for(let horario of horariosSelecionados) {
      promessas.push(
        db.ref(`compras-dia/${dataHoje}/${horario}/${codigoChave}`).set(dadosBase)
      );
    }

    selecionados.forEach(n => {
      promessas.push(db.ref(`numerosBloqueados/${n}`).set(true));
    });

    Promise.all(promessas).then(() => {
      alert("Reserva feita com sucesso!");

      carregarReservasDoDia(dataHoje);
      atualizarBloqueados();

      // Prepara código PIX, QR Code e dados para WhatsApp
      const totalPagar = valorUnit * selecionados.length;
      ultimoPix = gerarPixCodeReal(totalPagar);

      codigoPixTextarea.value = ultimoPix;
      pixContainer.style.display = "block";

      qrcodeDiv.innerHTML = "";
      QRCode.toCanvas(qrcodeDiv, ultimoPix, { width: 200 }, function (error) {
        if (error) console.error(error);
      });

      // Guarda dados para enviar WhatsApp (copia o estado antes de limpar)
      ultimaReserva = {
        nome,
        numeros: [...selecionados],
        horarios: horariosSelecionados,
        valorUnitario: valorUnit,
        totalPagar
      };

      // Limpar seleção e inputs
      selecionados = [];
      nomeInput.value = '';
      valorInput.value = '';
      totalPagarSpan.textContent = "0,00";
      horariosSelect.selectedIndex = -1;
      
  
        document.querySelectorAll('.numero.marcado').forEach(b => b.classList.remove('marcado'));
      }).catch(err => {
        alert("Erro ao salvar no Firebase: " + err);
      });
    });
  });

  btnCopiarPix.addEventListener('click', () => {
    if (!ultimoPix) return alert("Nenhum código PIX para copiar.");
    codigoPixTextarea.select();
    document.execCommand('copy');
    alert("Código PIX copiado!");
  });

  btnEnviarWhats.addEventListener('click', () => {
    const nome = nomeInput.value.trim();
    const horariosSelecionados = Array.from(horariosSelect.selectedOptions).map(o => o.value);
    const valorUnit = parseFloat(valorInput.value.replace(',', '.'));
    if (!nome || selecionados.length === 0 || horariosSelecionados.length === 0 || !valorUnit || valorUnit <= 0) {
      return alert("Para enviar via WhatsApp, preencha nome, selecione números, horários e informe o valor.");
    }
    const total = valorUnit * selecionados.length;
    const numerosStr = selecionados.join(", ");
    const msg = 
      `Reserva de Rifa:\n` +
      `Nome: ${nome}\n` +
      `Horários: ${horariosSelecionados.join(", ")}\n` +
      `Números: ${numerosStr}\n` +
      `Valor unitário: R$ ${valorUnit.toFixed(2).replace('.', ',')}\n` +
      `Total a pagar: R$ ${total.toFixed(2).replace('.', ',')}\n` +
      `Código PIX para pagamento:\n${ultimoPix}`;

    const urlWhats = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
    window.open(urlWhats, '_blank');
  });

  // Gera código PIX usando padrão simples (Exemplo básico, você pode adaptar para gerar QR real)
  function gerarPixCodeReal(valorTotal) {
    // Para um PIX real você deve gerar o payload oficial com CRC, mas aqui está uma versão simples:
    // Troque pela sua chave Pix real!
    const chavePix = "12345678900";
    const valorFormatado = valorTotal.toFixed(2).replace('.', '');
    // Exemplo simplificado, sem CRC real:
    return `00020126580014BR.GOV.BCB.PIX0136${chavePix}0208Pagamento520400005303986540${valorTotal.toFixed(2).replace('.', '')}5802BR5925Rifa Online - Reserva6009Sao Paulo61080540900062070503***6304ABCD`;
  }

  atualizarBloqueados();
</script>

</body>
  </html>
  
